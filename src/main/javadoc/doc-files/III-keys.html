<!--
  ~ This is free and unencumbered software released into the public domain.
  -->
<html>
<head>
    <title>Package Documentation for com.mycompany web app demo</title>
    <a href="../overview-summary.html">Back to top</a>
</head>
<body>
<p>
<hr>
<h3>Section III - Managing PKI Keys</h3>
<img src="keys.jpg">
<br><br>
This app uses SSL for confidential communication between the Java client and corresponding servers.
For SSL communication to work, a private key must be generated and configured for use within the servers as described in sections:
<a href="V-fortress.html">Fortress</a> and <a href="VI-mysql.html">MySQL</a>
Likewise, a public key must be imported into a Java truststore utilized by the demo Web application client.
If SSL connectivity is to occur between a client and server residing on separate machines, the public key's common name must match the hostname
of the OpenLDAP and MySQL servers.
<hr>
<h4>Pick one of the following options for obtaining PKI keys:</h4>
<ol type="A">

    <li>
        Use the test certificate & keys supplied by the <a href="V-fortress.html">Fortress Quickstart</a> package.
        <br>For this option you may skip to the next section: <a href="IV-hosts.html">Set hostname on target machine</a>..
    </li>
    <br>
    <li>
        Create a self-signed certificate using <a href="http://www.openssl.org">OpenSSL</a>.  For this option, follow the instructions that follow below.
    </li>
    <br>
    <li>
        Use a valid CA to sign the keys.  The instructions for this are beyond the scope of this document.
    </li>
</ol>
<hr>
<h4>Create new SSL Keys</h4>
<ol>
    <li>
        Create a folder to work in:
        <pre>
            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
mkdir certs
cd certs
~certs$
            </p>
        </pre>
    </li>

    <li>
        Create CA certificate:
        <ol type="a">
            <br>
            <li>
                Generate new RSA private key:
                <ol type="i">
                    <br>
                    <li>
                        Create private key:
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt; font-size: 14pt">
~/certs$ openssl genrsa 2048 > ca-key.pem
Generating RSA private key, 2048 bit long modulus
.....+++
...............................................................................................................................................................+++
e is 65537 (0x10001)
                            </p>
                        </pre>
                    </li>

                    <li>
                        verify:
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
~/certs$ ls
ca-key.pem
                            </p>
                        </pre>
                    </li>

                    <li>
                        ca-key.pem is private key
                    </li>

                </ol>

            </li>

            <br>

            <li>
                Generate Certificate Request.  The answers to the prompts may be chosen arbitrarily but again the common name must match the hostname on target server (as they will be installed on the same machine):
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
~/certs$ openssl req -new -x509 -nodes -days 3600 -key ca-key.pem -out ca-cert.pem
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
                    </p>
                </pre>

                <ol type="i">

                    <li>
                        Set country:
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Country Name (2 letter code) [AU]:US
                            </p>
                        </pre>

                    </li>

                    <li>
                        Set state:
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
State or Province Name (full name) [Some-State]:California
                            </p>
                        </pre>
                    </li>
                    <li>
                        Set city:
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Locality Name (eg, city) []:Joshua Tree
                            </p>
                        </pre>

                    </li>

                    <li>
                        Set Organization name:
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Organization Name (eg, company) [Internet Widgits Pty Ltd]:mycompanyname
                            </p>
                        </pre>

                    </li>

                    <li>
                        Set Organiational Unit Name (this may be left blank):
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Organizational Unit Name (eg, section) []:mygroupname
                            </p>
                        </pre>
                    </li>

                    <li>
                        Set Common Name, i.e. hostname of target machine.  Note this is the most important setting and name you specify here must match the
                        value entered in Step 1.
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Common Name (e.g. server FQDN or YOUR name) []:fortressdemo2.com
                            </p>
                        </pre>
                    </li>

                    <li>
                        Set Email Address (this may be left blank):
                        <pre>
                            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Email Address []:
                            </p>
                        </pre>
                    </li>
                </ol>

            </li>

            <br>

            <li>
                verify certificate present (ca-cert.pem):
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
~/certs$ ls
ca-cert.pem  ca-key.pem
                    </p>
                </pre>
            </li>

        </ol>

    </li>

    <li>
        Create server certificate:
        <ol type="i">

            <br>

            <li>
                Create new server keys:
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
~/certs$ openssl req -newkey rsa:2048 -days 1825 -nodes -keyout server-key.pem -out server-req.pem
Generating a 2048 bit RSA private key
................................................................................................................................................+++
........................+++
writing new private key to 'server-key.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
                    </p>
                </pre>
            </li>

            <li>
                Step through the prompts:
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:California
Locality Name (eg, city) []:Joshua Tree
Organization Name (eg, company) [Internet Widgits Pty Ltd]:mycompanyname
Organizational Unit Name (eg, section) []:mygroupname
Common Name (e.g. server FQDN or YOUR name) []:Shawn McKinney
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:changeit
An optional company name []:
                    </p>
                </pre>
            </li>

            <li>
                Remove the pass phrase on an RSA private key:
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt">
~/certs$ openssl rsa -in server-key.pem -out server-key.pem
writing RSA key
                    </p>
                </pre>
            </li>

            <li>
                Sign the public certificate:
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt">
~/certs$ openssl x509 -req -in server-req.pem -days 1825 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
Signature ok
subject=/C=US/ST=California/L=Joshua Tree/O=mycompanyname/OU=mygroupname/CN=Shawn McKinney
                    </p>
                </pre>
            </li>

            <li>
                The following files will be used later:
                <pre>
                    <p style="color: white; background-color: black; font-size: 14pt">
~/certs$ ls
ca-cert.pem  server-cert.pem  server-key.pem
                    </p>
                </pre>
            </li>
        </ol>
    </li>


    <li>
        Create PKCS12 Keystore.  This will be converted into a Java Keystore on next step.
        <pre>
            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
openssl pkcs12 -export -name fortressDemo2ServerCACert -in server-cert.pem -inkey server-key.pem -out mykeystore.p12
            </p>
        </pre>
    </li>

    <li>
        Import PKCS12 into Java Keystore (JKS).  This will be used for Tomcat HTTPS connectivity.
        <pre>
            <p style="color: white; background-color: black; font-size: 14pt; font-size: 14pt">
keytool -importkeystore -destkeystore mykeystore -srckeystore mykeystore.p12 -srcstoretype pkcs12 -alias fortressDemo2ServerCACert
            </p>
        </pre>
    </li>

    <li>
        Create Java truststore for JSSE.  This will be used for client-side SSL connectivity.
        as a Java truststore is provided in Quickstart package.
        <br>
        <ol type="a">
            <br>
            <li>
                Set JAVA_HOME environment variable to point to Java SDK installation on target machine:
                      <pre>
                        <p style="color: white; background-color: black; font-size: 14pt">
 ~/certs$ export JAVA_HOME=/opt/jdk1.7.0_10/
                        </p>
                      </pre>
            </li>

            <li>
                Import public key from Step 2 into the Java truststore.  If you use the keys supplied with this demo, they are located under /src/test/resources/certs
                in the Fortress Quickstart package.
                      <pre>
                        <p style="color: white; background-color: black; font-size: 14pt">
~/certs$ $JAVA_HOME/bin/keytool -import -alias fortressDemo2ServerCACert -file ca-cert.pem -keystore mytruststore
Enter keystore password:
Re-enter new password:
Owner: CN=fortressdemo2.com, OU=mygroupname, O=mycompanyname, L=Joshua Tree, ST=California, C=US
Issuer: CN=fortressdemo2.com, OU=mygroupname, O=mycompanyname, L=Joshua Tree, ST=California, C=US
Serial number: fae6c81e389bbeef
Valid from: Tue Aug 05 08:47:43 PDT 2014 until: Thu Jun 13 08:47:43 PDT 2024
Certificate fingerprints:
MD5:  8E:DF:5F:4E:CB:ED:33:E7:72:1E:76:D8:15:60:48:A5
SHA1: 18:35:4E:32:10:4D:D2:D4:52:A0:70:31:CE:1D:99:AB:14:23:EC:8C
SHA256: C6:37:4F:E5:59:C7:4B:DF:E2:FE:BA:7D:93:7C:03:FA:29:12:8F:F1:53:EF:E6:B5:5F:09:A4:53:6A:5F:C4:04
Signature algorithm name: SHA1withRSA
Version: 3

Extensions:

#1: ObjectId: 2.5.29.35 Criticality=false
AuthorityKeyIdentifier [
KeyIdentifier [
0000: AE C6 DD DE 82 84 4D 0E   48 FB CF 79 40 16 D1 3A  ......M.H..y@..:
0010: 00 D3 16 4B                                        ...K
]
]

#2: ObjectId: 2.5.29.19 Criticality=false
BasicConstraints:[
CA:true
PathLen:2147483647
]

#3: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: AE C6 DD DE 82 84 4D 0E   48 FB CF 79 40 16 D1 3A  ......M.H..y@..:
0010: 00 D3 16 4B                                        ...K
]
]

Trust this certificate? [no]:  yes
Certificate was added to keystore
                        </p>
                      </pre>
            </li>

            <li>
                Verify artifacts generated:
                      <pre>
                        <p style="color: white; background-color: black; font-size: 14pt">
~/certs$ ls
ca-cert.pem  ca-key.pem  mykeystore  mykeystore.p12  mytruststore  server-cert.pem  server-key.pem  server-req.pem
                        </p>
                      </pre>
            </li>

            <li>
                Artifacts will be used as follows:
                <ol type="a">
                    <br>
                    <li>
                        <b>ca-cert.pem</b>, <b>server-cert.pem</b>, <b>server-key.pem</b>
                        <br>-Server-side, used by OpenLDAP and MySQL
                    </li>
                    <br>
                    <li>
                        <b>mytruststore</b>
                        <br>-Client-side, used by demo web app to connect with OpenLDAP and MySQL:
                    </li>
                    <br>
                    <li>
                        <b>mykeystore</b>
                        <br>-Server-side, used by Tomcat for HTTPS connections:
                    </li>
                </ol>
            </li>
        </ol>

    </li>
</ol>
</body>
<p style="color: black; font-size: 6pt">This is free and unencumbered software released into the public domain.</p>
</html>